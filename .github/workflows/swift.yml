# This workflow will build and test the Thrive Church Official App iOS project for dev branch
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: Swift Dev Build

on:
  push:
    branches: [ "dev", "master" ]
  pull_request:
    branches: [ "dev", "master" ]

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods dependencies
      run: |
        sudo gem install cocoapods
        pod install

    - name: List available simulators
      run: xcrun simctl list devices available

    - name: Fix plist file paths
      run: |
        echo "Current directory:"
        pwd
        echo "Files in current directory:"
        ls -la
        echo "Checking if plist files exist:"
        if [ -f "Config.plist" ]; then
          echo "✅ Config.plist found"
        else
          echo "❌ Config.plist not found"
        fi
        if [ -f "GoogleService-Info.plist" ]; then
          echo "✅ GoogleService-Info.plist found"
        else
          echo "❌ GoogleService-Info.plist not found"
        fi
        echo "Files are in the correct location for GitHub Actions"

    - name: Build project
      run: |
        # Set SRCROOT to current directory to help Xcode find the plist files
        export SRCROOT="$(pwd)"
        echo "SRCROOT set to: $SRCROOT"

        xcodebuild build \
          -workspace "Thrive Church Official App.xcworkspace" \
          -scheme "Thrive Church Official App" \
          -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation)' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          SRCROOT="$SRCROOT"

    - name: Run unit tests
      run: |
        export SRCROOT="$(pwd)"
        xcodebuild test \
          -workspace "Thrive Church Official App.xcworkspace" \
          -scheme "Thrive Church Official App" \
          -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation)' \
          -only-testing:"Thrive Church Official AppTests" \
          CODE_SIGNING_ALLOWED=NO \
          SRCROOT="$SRCROOT"

    - name: Run UI tests
      run: |
        export SRCROOT="$(pwd)"
        xcodebuild test \
          -workspace "Thrive Church Official App.xcworkspace" \
          -scheme "Thrive Church Official App" \
          -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation)' \
          -only-testing:"Thrive Church Official AppUITests" \
          CODE_SIGNING_ALLOWED=NO \
          SRCROOT="$SRCROOT"
      continue-on-error: true  # UI tests may have known issues as mentioned in the codebase

    - name: Run comprehensive tests on iPad
      run: |
        export SRCROOT="$(pwd)"
        xcodebuild test \
          -workspace "Thrive Church Official App.xcworkspace" \
          -scheme "Thrive Church Official App" \
          -destination 'platform=iOS Simulator,name=iPad (10th generation)' \
          -only-testing:"Thrive Church Official AppTests" \
          CODE_SIGNING_ALLOWED=NO \
          SRCROOT="$SRCROOT"
      continue-on-error: true  # Allow iPad tests to fail without breaking the build

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          *.xcresult
          DerivedData/Logs/Test/*.xcresult
